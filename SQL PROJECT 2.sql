CREATE TABLE users (
    USER_ID INT PRIMARY KEY,
    USER_NAME VARCHAR(20) NOT NULL,
    USER_STATUS VARCHAR(20) NOT NULL
);

CREATE TABLE logins (
    USER_ID INT,
    LOGIN_TIMESTAMP DATETIME NOT NULL,
    SESSION_ID INT PRIMARY KEY,
    SESSION_SCORE INT,
    FOREIGN KEY (USER_ID) REFERENCES USERS(USER_ID)
);

-- Users Table
INSERT INTO USERS VALUES (1, 'Alice', 'Active');
INSERT INTO USERS VALUES (2, 'Bob', 'Inactive');
INSERT INTO USERS VALUES (3, 'Charlie', 'Active');
INSERT INTO USERS  VALUES (4, 'David', 'Active');
INSERT INTO USERS  VALUES (5, 'Eve', 'Inactive');
INSERT INTO USERS  VALUES (6, 'Frank', 'Active');
INSERT INTO USERS  VALUES (7, 'Grace', 'Inactive');
INSERT INTO USERS  VALUES (8, 'Heidi', 'Active');
INSERT INTO USERS VALUES (9, 'Ivan', 'Inactive');
INSERT INTO USERS VALUES (10, 'Judy', 'Active');




-- Logins Table 
INSERT INTO LOGINS  VALUES (1, '2024-07-15 09:30:00', 1001, 85);
INSERT INTO LOGINS VALUES (2, '2024-07-22 10:00:00', 1002, 90);
INSERT INTO LOGINS VALUES (3, '2024-08-10 11:15:00', 1003, 75);
INSERT INTO LOGINS VALUES (4, '2024-08-20 14:00:00', 1004, 88);
INSERT INTO LOGINS  VALUES (5, '2024-09-05 16:45:00', 1005, 82);
INSERT INTO LOGINS  VALUES (6, '2024-10-12 08:30:00', 1006, 77);
INSERT INTO LOGINS  VALUES (7, '2024-11-18 09:00:00', 1007, 81);
INSERT INTO LOGINS VALUES (8, '2024-12-01 10:30:00', 1008, 84);
INSERT INTO LOGINS  VALUES (9, '2024-12-15 13:15:00', 1009, 79);
-- 2024-2025 
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (1, '2024-01-10 07:45:00', 1011, 86);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (2, '2024-01-25 09:30:00', 1012, 89);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (3, '2024-02-05 11:00:00', 1013, 78);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (4, '2024-03-01 14:30:00', 1014, 91);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (5, '2024-03-15 16:00:00', 1015, 83);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (6, '2024-04-12 08:00:00', 1016, 80);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (7, '2024-05-18 09:15:00', 1017, 82);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (8, '2024-05-28 10:45:00', 1018, 87);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (9, '2024-06-15 13:30:00', 1019, 76);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (10, '2025-07-25 15:00:00', 1010, 92);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (10, '2025-07-26 15:45:00', 1020, 93);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (10, '2025-07-27 15:00:00', 1021, 92);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (10, '2025-07-28 15:45:00', 1022, 93);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (1, '2024-01-10 07:45:00', 1101, 86);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (3, '2024-01-25 09:30:00', 1102, 89);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (5, '2024-01-15 11:00:00', 1103, 78);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (2, '2025-11-10 07:45:00', 1201, 82);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (4, '2025-11-25 09:30:00', 1202, 84);
INSERT INTO LOGINS (USER_ID, LOGIN_TIMESTAMP, SESSION_ID, SESSION_SCORE) VALUES (6, '2025-11-15 11:00:00', 1203, 80);



select * from LOGINS;
select * from USERS;




-----1.MANAGEMENT WANTS TO SEE ALL THE USERS THAT DID NOT LOGIN IN THE PAST 5 MONTHS.

---APPROACH_1
WITH CTE7 AS(
SELECT USER_ID,MAX(LOGIN_TIMESTAMP) AS LATEST_LOGIN FROM LOGINS
GROUP BY USER_ID
HAVING MAX(LOGIN_TIMESTAMP)<DATEADD(MONTH,-5,GETDATE()))

SELECT CTE7.*,USERS.USER_NAME FROM CTE7 
INNER JOIN USERS ON  CTE7.USER_ID=USERS.USER_ID;


---APPROACH_2

WITH CTE8 AS(
SELECT  DISTINCT USER_ID FROM LOGINS WHERE USER_ID NOT IN(
SELECT USER_ID FROM LOGINS
GROUP BY USER_ID
HAVING MAX(LOGIN_TIMESTAMP)>DATEADD(MONTH,-5,GETDATE())))

SELECT CTE8.*, USERS.USER_NAME FROM CTE8
INNER JOIN USERS ON CTE8.USER_ID=USERS.USER_ID;




-----2.FOR THE BUSINESS UNITS' QUARTERLY ANALYSIS,CALCULATE HOW MANY USERS AND HOW MANY SESSIONS WERE AT EACH QUARTER
----ORDER BY THE QUARTER NEWEST TO OLDEST.


SELECT DATEPART(QUARTER,LOGIN_TIMESTAMP) AS QUARTER_NUMBER,COUNT(*) AS SESSION_COUNT,
COUNT(DISTINCT USER_ID) AS USER_COUNT,MIN(LOGIN_TIMESTAMP) AS FIRST_DATE_LOGIN,
DATETRUNC(QUARTER,MIN(LOGIN_TIMESTAMP)) AS FIRST_DAY_OF_QUARTER FROM LOGINS
GROUP BY DATEPART(QUARTER,LOGIN_TIMESTAMP);

---- EXAMPLE OF DATETRUNC FUNCTION
----DATETRUNC(year, date)	2025-01-01 00:00:00
----DATETRUNC(month, date)	2025-12-01 00:00:00
----DATETRUNC(day, date)	2025-12-11 00:00:00
----DATETRUNC(hour, date)	2025-12-11 15:00:00





-----3.1.DISPLAY USERS_ID THAT LOGIN IN 2024 OCT AND ALSO LOGIN ON 2025 NOV  

SELECT USER_ID FROM LOGINS 
WHERE LOGIN_TIMESTAMP BETWEEN '2024-10-01' AND '2024-10-31' AND 
USER_ID IN (SELECT USER_ID FROM LOGINS WHERE LOGIN_TIMESTAMP BETWEEN '2025-11-01' AND '2025-11-30');


--WHERE LOGIN_TIMESTAMP BETWEEN '2024-10-01' AND '2024-10-31'
--6

--WHERE LOGIN_TIMESTAMP BETWEEN '2025-11-01' AND '2025-11-30';
--2,4,6

-----3.2.DISPLAY USERS_ID AND USER_NAME THAT LOGIN IN 2025 NOV BUT ALSO  NOT LOGIN ON 2024 OCT.
WITH CTE9 AS(
SELECT USER_ID FROM LOGINS 
WHERE LOGIN_TIMESTAMP BETWEEN '2025-11-01' AND '2025-11-30' AND 
USER_ID NOT  IN (SELECT USER_ID FROM LOGINS WHERE LOGIN_TIMESTAMP BETWEEN '2024-10-01' AND '2024-10-31'))

SELECT CTE9.USER_ID,USERS.USER_NAME FROM CTE9
INNER JOIN USERS ON CTE9.USER_ID=USERS.USER_ID;



-----4.ADD TO THE QUERY 2 THE PERCENTAGE CHANGE IN SESSIONS FROM LAST QUARTER.


WITH CTE10 AS(
SELECT DATETRUNC(QUARTER,MIN(LOGIN_TIMESTAMP)) AS FIRST_DAY_OF_QUARTER,
DATEPART(QUARTER,LOGIN_TIMESTAMP) AS QUARTER_NUMBER,
COUNT(*) AS SESSION_COUNT
FROM LOGINS
GROUP BY DATEPART(QUARTER,LOGIN_TIMESTAMP))
SELECT CTE10.*, LAG(SESSION_COUNT) OVER (ORDER BY FIRST_DAY_OF_QUARTER) AS PREVIOUS_QUARTER_SESSION,
(SESSION_COUNT- LAG(SESSION_COUNT) OVER (ORDER BY FIRST_DAY_OF_QUARTER))*100.00/LAG(SESSION_COUNT) OVER (ORDER BY FIRST_DAY_OF_QUARTER) AS INCREASE_PERCENTAGE
FROM CTE10;




-----5.DISPLAY THE USER THAT HAD THE HIGHEST SESSION SCORE(MAX) FOR EACH DAY.

WITH CTE11 AS(
SELECT USER_ID,CAST(LOGIN_TIMESTAMP AS DATE) AS LOGIN_DATE,SUM(SESSION_SCORE) AS TOTAL_SCORE  FROM LOGINS
GROUP BY USER_ID,CAST(LOGIN_TIMESTAMP AS DATE))

SELECT * FROM (
SELECT CTE11.*,ROW_NUMBER() OVER(PARTITION BY LOGIN_DATE ORDER BY TOTAL_SCORE DESC) AS RN 
FROM CTE11) A
WHERE RN=1;



-----6.TO IDENTIFY OUR BEST USERS - RETURN THE USERS THAT HAD A SESSION ON EVERY SINGLE DAY SINCE THEIR FIRST LOGIN.
-----THIS IS NOT POSSIBLE DUE I HAVE MADE SOME DATE CHANGES AND DATE WAS QUITE OLD AS PER MY DATE 11-12-2025 SO 
-----INSTEAD OF GETDATE() I USE WHOEVER ATTEND 3 BACK TO BACK CLASSES, HIS LAST DATE  AS LATEST DATE.  
-----LET'S TAKE 28-07-2025 -TODAY INSTEAD OF GETDATE() CAUSE IN DATASET ONLY USER_ID 10 HAS 3 BACK TO BACK LOGIN.

SELECT USER_ID,MIN(CAST(LOGIN_TIMESTAMP AS DATE)) AS FIRST_LOGIN,
DATEDIFF(DAY,MIN(CAST(LOGIN_TIMESTAMP AS DATE)),'2025-07-28')+1 AS NUMBER_OF_LOGIN_REQUIRES,--NEED TO ADD +1 CAUSE , FROM 28 TO 25=4 DAYS BUT DATEDIFF GIVES 3.
COUNT (DISTINCT(CAST(LOGIN_TIMESTAMP AS DATE)))  AS NUMBER_OF_LOGINS
FROM LOGINS
GROUP BY USER_ID
HAVING(DATEDIFF(DAY,MIN(CAST(LOGIN_TIMESTAMP AS DATE)),'2025-07-28')+1)=(COUNT (DISTINCT(CAST(LOGIN_TIMESTAMP AS DATE))))
ORDER BY USER_ID



-----7. ON WHAT DATES THERE WERE NO LOGIN AT ALL? (FROM START TO END DATE IN LOGIN_TIMESTAMP)

WITH CTE12 AS (
SELECT CAST(MIN(LOGIN_TIMESTAMP) AS DATE) AS FIRST_DATE,CAST(MAX(LOGIN_TIMESTAMP) AS DATE) AS LAST_DATE FROM LOGINS
UNION ALL
SELECT DATEADD(DAY,1,FIRST_DATE) AS FIRST_DATE,LAST_DATE FROM CTE12 
WHERE FIRST_DATE<LAST_DATE)

SELECT* FROM CTE12
WHERE FIRST_DATE NOT IN (SELECT DISTINCT CAST(LOGIN_TIMESTAMP AS DATE) FROM LOGINS)
OPTION(MAXRECURSION 700)